<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alojamientos en Mendoza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex-grow: 1;
            display: flex;
            padding-top: 1.5rem;
            padding-bottom: 3rem;
        }

        .card {
            overflow: visible !important;
            position: relative;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #loadingMessage {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #555;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .carousel-images {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }

        .carousel-images img {
            width: 100%;
            flex-shrink: 0;
            height: 224px;
            object-fit: cover;
        }

        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 10;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
        }

        .carousel-button:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .carousel-button.prev {
            left: 0.5rem;
        }

        .carousel-button.next {
            right: 0.5rem;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 1.5rem;
            margin-top: 0.5rem;
        }

        .collapsible-content.expanded {
            max-height: 9999px;
            padding-bottom: 1rem;
        }

        .collapsible-button {
            width: 100%;
            background-color: #f3f4f6;
            color: #4b5563;
            padding: 0.75rem 1.5rem;
            border: none;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border-radius: 0.375rem;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .collapsible-button:hover {
            background-color: #e5e7eb;
        }

        .collapsible-button i {
            margin-left: 0.5rem;
            transition: transform 0.3s ease-in-out;
        }

        .collapsible-button.active i {
            transform: rotate(180deg);
        }

        .dropdown-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-radius: 0.375rem;
            overflow: hidden;
            width: 100%;
            left: 0;
            top: 100%;
            transform: translateY(0.25rem);
        }

        .dropdown-content a {
            display: flex;
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            transition: background-color 0.2s;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content a i {
            margin-right: 0.5rem;
            width: 1rem;
        }

        .dropdown-container.open .dropdown-content {
            display: block;
        }

        .card.active-card {
            z-index: 999;
        }

        #alojamientosContainer {
            align-items: start;
        }

        /* --- Estilos para la barra lateral y el contenido principal --- */
        #filterSidebar {
            width: 280px;
            min-width: 280px;
            margin-right: 2rem;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 1.5rem;
            height: fit-content;
            align-self: flex-start;
        }

        #contentArea {
            flex-grow: 1;
            max-width: calc(100% - 280px - 2rem);
        }

        /* Ajustes para dispositivos móviles */
        @media (max-width: 768px) {
            main {
                flex-direction: column;
                align-items: center;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }

            #filterSidebar {
                width: 100%;
                max-width: 400px;
                margin-right: 0;
                margin-bottom: 2rem;
                position: static;
                top: auto;
            }

            #contentArea {
                max-width: 100%;
            }

            #alojamientosContainer {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para los selectores de radio */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            /* Espacio entre los radios */
            padding: 0.5rem 0;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .radio-item:hover {
            background-color: #eff6ff;
            /* Color de fondo al pasar el mouse */
        }

        .radio-item input[type="radio"] {
            flex-shrink: 0;
            width: 1.15rem;
            height: 1.15rem;
            accent-color: #4f46e5;
        }

        .radio-item label {
            flex-grow: 1;
            margin-left: 0.6rem;
            font-size: 0.925rem;
            color: #374151;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <header class="bg-gradient-to-r from-black to-gray-700 text-white shadow-lg">
        <div class="container mx-auto px-6 py-8 text-center">
            <h1 class="text-4xl font-bold">Descubre Alojamientos en Mendoza</h1>
            <p class="mt-2 text-lg">Encuentra el lugar perfecto para tu estadía en la tierra del sol y el buen vino.</p>
        </div>
    </header>

    <main class="container mx-auto px-6">
        <div id="filterSidebar">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Filtrar Alojamientos</h2>

            <div id="filterSection" class="flex flex-col gap-4 mb-6">
                <div class="filter-group">
                    <label for="capacidadMaximaFilter"
                        class="block text-sm font-medium text-gray-700 mb-1">Personas:</label>
                    <input type="number" id="capacidadMaximaFilter" min="1" placeholder="Ej: 4"
                        class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                </div>

                <div class="filter-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación:</label>
                    <div id="ubicacionFilterRadios" class="radio-group">
                    </div>
                </div>

                <div class="flex flex-col gap-2 mt-4">
                    <button id="applyFiltersButton"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 whitespace-nowrap">Aplicar
                        Filtros</button>
                    <button id="clearFiltersButton"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors duration-300 whitespace-nowrap">Limpiar
                        Filtros</button>
                </div>
            </div>
        </div>

        <div id="contentArea">
            <div id="alojamientosContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>
            <div id="loadingMessage" style="display: none;">Cargando alojamientos...</div>
            <div id="noResultsMessage" class="text-gray-600 text-center mt-4" style="display: none;">No se encontraron
                alojamientos que coincidan con los filtros aplicados.</div>
            <button id="loadMoreButton"
                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mt-8 w-full transition-colors duration-300"
                style="display: none;">Ver más</button>
            <div id="endOfResultsMessage" class="text-gray-600 text-center mt-4" style="display: none;">Has llegado al
                final de los resultados.</div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2025 Alojamientos Mendoza. Todos los derechos reservados.</p>
            <p class="mt-1 text-sm">Diseñado con <span class="text-red-500">&hearts;</span> para tu viaje.</p>
        </div>
    </footer>

    <script>
        const alojamientosContainer = document.getElementById('alojamientosContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage'); // Assuming you might have one for fetch errors
        const noResultsMessage = document.getElementById('noResultsMessage');
        const endOfResultsMessage = document.getElementById('endOfResultsMessage');
        const loadMoreButton = document.getElementById('loadMoreButton'); // New button

        const ubicacionFilterRadios = document.getElementById('ubicacionFilterRadios');
        const capacidadMaximaFilter = document.getElementById('capacidadMaximaFilter');

        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const jsonFile = 'alojamientos.json';

        let allAlojamientos = [];
        let filteredAlojamientos = [];
        let itemsPerPage = 9;
        let currentPage = 1;
        let isLoadingMore = false; // To prevent multiple loads during scroll

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-container.open').forEach(openDropdown => {
                const associatedCard = openDropdown.closest('.card');
                if (associatedCard) {
                    associatedCard.classList.remove('active-card');
                }
                openDropdown.classList.remove('open');
            });
        }

        document.addEventListener('click', (e) => {
            const isClickInsideAnyDropdownContent = e.target.closest('.dropdown-content');
            const isClickInsideCollapsibleButton = e.target.closest('.collapsible-button');
            const isClickInsideDropdownButton = e.target.closest('.dropdown-container button');
            const isClickInsideRadioGroup = e.target.closest('.radio-group');

            if (!isClickInsideAnyDropdownContent && !isClickInsideCollapsibleButton && !isClickInsideDropdownButton && !isClickInsideRadioGroup) {
                closeAllDropdowns();
            }
        });


        function crearTarjetaAlojamiento(alojamiento) {
            const tieneWhatsAppValido = alojamiento.whatsapp && alojamiento.whatsapp.trim() !== "" && (alojamiento.activo === undefined || alojamiento.activo === true);

            const card = document.createElement('div');
            card.className = 'card bg-white rounded-lg shadow-md card-hover transition-all duration-300 flex flex-col';

            const carouselContainer = document.createElement('div');
            carouselContainer.className = 'carousel-container';
            const carouselImages = document.createElement('div');
            carouselImages.className = 'carousel-images';
            let currentImageIndex = 0;
            const imagesToDisplay = alojamiento.imagenes && alojamiento.imagenes.length > 0 ? alojamiento.imagenes : ['https://placehold.co/600x400/CCCCCC/FFFFFF?text=Imagen+No+Disponible'];

            imagesToDisplay.forEach(imgUrl => {
                const img = document.createElement('img');
                img.src = imgUrl;
                img.alt = `Imagen de ${alojamiento.nombre}`;
                img.className = 'w-full h-56 object-cover';
                img.onerror = () => { img.src = 'https://placehold.co/600x400/CCCCCC/FFFFFF?text=Error+Al+Cargar+Imagen'; };
                carouselImages.appendChild(img);
            });
            carouselContainer.appendChild(carouselImages);

            if (imagesToDisplay.length > 1) {
                const prevButton = document.createElement('button');
                prevButton.className = 'carousel-button prev';
                prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevButton.onclick = (e) => {
                    e.stopPropagation();
                    currentImageIndex = (currentImageIndex - 1 + imagesToDisplay.length) % imagesToDisplay.length;
                    carouselImages.style.transform = `translateX(-${currentImageIndex * 100}%)`;
                };
                carouselContainer.appendChild(prevButton);

                const nextButton = document.createElement('button');
                nextButton.className = 'carousel-button next';
                nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextButton.onclick = (e) => {
                    e.stopPropagation();
                    currentImageIndex = (currentImageIndex + 1) % imagesToDisplay.length;
                    carouselImages.style.transform = `translateX(-${currentImageIndex * 100}%)`;
                };
                carouselContainer.appendChild(nextButton);
            }
            card.appendChild(carouselContainer);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'p-6 flex flex-col flex-grow';

            const nombre = document.createElement('h3');
            nombre.className = 'text-2xl font-semibold text-gray-800 mb-2';
            nombre.textContent = alojamiento.nombre;
            contentDiv.appendChild(nombre);

            const descripcion = document.createElement('p');
            descripcion.className = 'text-gray-600 mb-4';
            descripcion.textContent = alojamiento.descripcion;
            contentDiv.appendChild(descripcion);

            if (alojamiento.detallesAdicionales || alojamiento.capacidad || (alojamiento.detallesAdicionales && (alojamiento.detallesAdicionales.servicios || alojamiento.detallesAdicionales.amenities))) {
                const collapsibleButton = document.createElement('button');
                collapsibleButton.className = 'collapsible-button';
                collapsibleButton.innerHTML = `Ver más detalles <i class="fas fa-chevron-down"></i>`;
                contentDiv.appendChild(collapsibleButton);

                const collapsibleContent = document.createElement('div');
                collapsibleContent.className = 'collapsible-content';

                if (alojamiento.detallesAdicionales && alojamiento.detallesAdicionales.titulo) {
                    const detallesTitulo = document.createElement('h4');
                    detallesTitulo.className = 'text-lg font-semibold text-gray-700 mb-2 mt-4';
                    detallesTitulo.textContent = alojamiento.detallesAdicionales.titulo;
                    collapsibleContent.appendChild(detallesTitulo);
                }
                if (alojamiento.detallesAdicionales && alojamiento.detallesAdicionales.textoExtenso) {
                    const textoExtenso = document.createElement('p');
                    textoExtenso.className = 'text-gray-600 text-sm mb-2';
                    textoExtenso.textContent = alojamiento.detallesAdicionales.textoExtenso;
                    collapsibleContent.appendChild(textoExtenso);
                }
                // Updated capacity display to use the 'capacidad' array
                if (alojamiento.capacidad && alojamiento.capacidad.length === 2) {
                    const capacidad = document.createElement('p');
                    capacidad.className = 'text-gray-700 text-sm mb-1';
                    capacidad.innerHTML = `<strong>Capacidad:</strong> ${alojamiento.capacidad[0]} - ${alojamiento.capacidad[1]} personas`;
                    collapsibleContent.appendChild(capacidad);
                }
                if (alojamiento.detallesAdicionales && alojamiento.detallesAdicionales.servicios && alojamiento.detallesAdicionales.servicios.length > 0) {
                    const serviciosTitulo = document.createElement('p');
                    serviciosTitulo.className = 'text-gray-700 text-sm font-semibold mt-2 mb-1';
                    serviciosTitulo.textContent = 'Servicios Incluidos:';
                    collapsibleContent.appendChild(serviciosTitulo);
                    const serviciosList = document.createElement('ul');
                    serviciosList.className = 'list-disc list-inside text-gray-600 text-sm mb-2';
                    alojamiento.detallesAdicionales.servicios.forEach(servicio => {
                        const listItem = document.createElement('li');
                        listItem.textContent = servicio;
                        serviciosList.appendChild(listItem);
                    });
                    collapsibleContent.appendChild(serviciosList);
                }
                if (alojamiento.detallesAdicionales && alojamiento.detallesAdicionales.amenities && alojamiento.detallesAdicionales.amenities.length > 0) {
                    const amenitiesTitulo = document.createElement('p');
                    amenitiesTitulo.className = 'text-gray-700 text-sm font-semibold mt-2 mb-1';
                    amenitiesTitulo.textContent = 'Comodidades de la habitación:';
                    collapsibleContent.appendChild(amenitiesTitulo);
                    const amenitiesList = document.createElement('ul');
                    amenitiesList.className = 'list-disc list-inside text-gray-600 text-sm mb-2';
                    alojamiento.detallesAdicionales.amenities.forEach(amenity => {
                        const listItem = document.createElement('li');
                        listItem.textContent = amenity;
                        amenitiesList.appendChild(listItem);
                    });
                    collapsibleContent.appendChild(amenitiesList);
                }

                contentDiv.appendChild(collapsibleContent);

                collapsibleButton.onclick = () => {
                    document.querySelectorAll('.collapsible-content.expanded').forEach(openContent => {
                        if (openContent !== collapsibleContent) {
                            openContent.classList.remove('expanded');
                            const relatedButton = openContent.previousElementSibling;
                            if (relatedButton && relatedButton.classList.contains('collapsible-button')) {
                                relatedButton.classList.remove('active');
                                relatedButton.querySelector('i').classList.remove('fa-chevron-up');
                                relatedButton.querySelector('i').classList.add('fa-chevron-down');
                            }
                        }
                    });

                    collapsibleContent.classList.toggle('expanded');
                    collapsibleButton.classList.toggle('active');
                    const icon = collapsibleButton.querySelector('i');
                    if (collapsibleContent.classList.contains('expanded')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                };
            }

            const infoDiv = document.createElement('div');
            infoDiv.className = 'flex justify-between items-center mt-auto mb-4';
            const precio = document.createElement('span');
            precio.className = 'text-xl font-bold text-purple-600';
            precio.textContent = alojamiento.precio;
            infoDiv.appendChild(precio);
            const ubicacion = document.createElement('span');
            ubicacion.className = 'text-sm text-gray-500';
            ubicacion.textContent = alojamiento.ubicacion;
            infoDiv.appendChild(ubicacion);
            contentDiv.appendChild(infoDiv);

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'grid grid-cols-1 sm:grid-cols-2 gap-2';

            const dropdownContainer = document.createElement('div');
            dropdownContainer.className = 'dropdown-container';
            const detallesButton = document.createElement('button');
            detallesButton.className = 'w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-center flex items-center justify-center';
            detallesButton.innerHTML = `Redes Sociales <i class="fas fa-caret-down ml-auto"></i>`;
            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';

            let hasSocialMedia = false;
            if (alojamiento.redesSociales) {
                for (const platform in alojamiento.redesSociales) {
                    if (alojamiento.redesSociales.hasOwnProperty(platform) && alojamiento.redesSociales[platform]) {
                        const socialLink = document.createElement('a');
                        socialLink.href = alojamiento.redesSociales[platform];
                        socialLink.target = '_blank';
                        socialLink.rel = 'noopener noreferrer';
                        let iconClass = '';
                        switch (platform.toLowerCase()) {
                            case 'facebook': iconClass = 'fab fa-facebook-f'; break;
                            case 'instagram': iconClass = 'fab fa-instagram'; break;
                            case 'twitter': iconClass = 'fab fa-twitter'; break;
                            case 'website': iconClass = 'fas fa-globe'; break;
                            case 'email': iconClass = 'fas fa-envelope'; break;
                            default: iconClass = 'fas fa-link';
                        }
                        socialLink.innerHTML = `<i class="${iconClass}"></i> ${platform.charAt(0).toUpperCase() + platform.slice(1)}`;

                        dropdownContent.appendChild(socialLink);
                        hasSocialMedia = true;
                    }
                }
            }

            if (hasSocialMedia) {
                dropdownContainer.appendChild(detallesButton);
                dropdownContainer.appendChild(dropdownContent);
                buttonsDiv.appendChild(dropdownContainer);

                detallesButton.onclick = (e) => {
                    e.stopPropagation();
                    if (!dropdownContainer.classList.contains('open')) {
                        closeAllDropdowns();
                    }
                    dropdownContainer.classList.toggle('open');
                    if (dropdownContainer.classList.contains('open')) {
                        card.classList.add('active-card');
                    } else {
                        card.classList.remove('active-card');
                    }
                };
                dropdownContent.addEventListener('click', (e) => { e.stopPropagation(); });
            } else {
                const noSocialMediaButton = document.createElement('button');
                noSocialMediaButton.className = 'w-full bg-gray-300 text-gray-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed';
                noSocialMediaButton.textContent = 'Redes (No disponibles)';
                noSocialMediaButton.disabled = true;
                buttonsDiv.appendChild(noSocialMediaButton);
            }

            if (tieneWhatsAppValido) {
                const whatsappLink = document.createElement('a');
                const numeroLimpio = alojamiento.whatsapp.replace(/\D/g, '');

                const saludoCodificado = alojamiento.saludo ? encodeURIComponent(alojamiento.saludo) : '';

                whatsappLink.href = `https://wa.me/${numeroLimpio}${saludoCodificado ? `?text=${saludoCodificado}` : ''}`;

                whatsappLink.target = '_blank';
                whatsappLink.rel = 'noopener noreferrer';
                whatsappLink.className = 'w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-center';
                whatsappLink.textContent = 'WhatsApp';
                buttonsDiv.appendChild(whatsappLink);

            } else {
                const noWhatsAppButton = document.createElement('button');
                noWhatsAppButton.className = 'w-full bg-gray-300 text-gray-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed';
                noWhatsAppButton.textContent = 'WhatsApp (No disponible)';
                noWhatsAppButton.disabled = true;
                buttonsDiv.appendChild(noWhatsAppButton);
            }

            contentDiv.appendChild(buttonsDiv);
            card.appendChild(contentDiv);
            return card;
        }

        function populateFilters(alojamientos) {
            console.log("populateFilters called.");
            const ubicaciones = new Set(alojamientos.map(a => a.ubicacion).filter(Boolean));
            ubicacionFilterRadios.innerHTML = '';

            const allUbicacionesDiv = document.createElement('div');
            allUbicacionesDiv.className = 'radio-item';
            allUbicacionesDiv.onclick = function () {
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    filterAndSortAlojamientos();
                }
            };
            const allUbicacionesInput = document.createElement('input');
            allUbicacionesInput.type = 'radio';
            allUbicacionesInput.id = `ubicacion-todas`;
            allUbicacionesInput.name = 'ubicacionFilter';
            allUbicacionesInput.value = '';
            allUbicacionesInput.checked = true;
            allUbicacionesInput.className = 'h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500';
            allUbicacionesInput.addEventListener('click', (e) => e.stopPropagation());
            const allUbicacionesLabel = document.createElement('label');
            allUbicacionesLabel.htmlFor = allUbicacionesInput.id;
            allUbicacionesLabel.className = 'ml-2 block text-sm text-gray-900 cursor-pointer';
            allUbicacionesLabel.textContent = 'Todas';
            allUbicacionesDiv.appendChild(allUbicacionesInput);
            allUbicacionesDiv.appendChild(allUbicacionesLabel);
            ubicacionFilterRadios.appendChild(allUbicacionesDiv);


            Array.from(ubicaciones).sort().forEach(ubicacion => {
                const div = document.createElement('div');
                div.className = 'radio-item';
                div.onclick = function () {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        filterAndSortAlojamientos();
                    }
                };

                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `ubicacion-${ubicacion.replace(/\s/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}`;
                input.name = 'ubicacionFilter';
                input.value = ubicacion;
                input.className = 'h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500';
                input.addEventListener('click', (e) => e.stopPropagation());

                const label = document.createElement('label');
                label.htmlFor = input.id;
                label.className = 'ml-2 block text-sm text-gray-900 cursor-pointer';
                label.textContent = ubicacion;
                div.appendChild(input);
                div.appendChild(label);
                ubicacionFilterRadios.appendChild(div);
            });
        }

        function displayAlojamientos(alojamientosToDisplay, append = false) {
            console.log("displayAlojamientos called. Append:", append, "Current Page:", currentPage, "Alojamientos to display total:", alojamientosToDisplay.length);
            noResultsMessage.style.display = 'none';
            endOfResultsMessage.style.display = 'none';
            loadMoreButton.style.display = 'none'; // Hide button by default until we know it's needed

            if (!append) {
                alojamientosContainer.innerHTML = '';
                currentPage = 1; // Reset to first page only if not appending
                console.log("Container cleared, pagination reset.");
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const alojamientosToRender = alojamientosToDisplay.slice(startIndex, endIndex);

            if (alojamientosToRender.length > 0) {
                alojamientosToRender.forEach(alojamiento => {
                    const debeMostrar = alojamiento.activo === true || alojamiento.mostrarSiInactivo === true;
                    if (debeMostrar) {
                        const tarjeta = crearTarjetaAlojamiento(alojamiento);
                        if (tarjeta) {
                            alojamientosContainer.appendChild(tarjeta);
                        }
                    }
                });
                console.log(`Rendered ${alojamientosToRender.length} cards. Total rendered so far (approx): ${startIndex + alojamientosToRender.length}`);

                // Check if there are more items to load in filteredAlojamientos
                if (endIndex < alojamientosToDisplay.length) {
                    loadMoreButton.style.display = 'block'; // Show "Load More" button
                    console.log("More items available, showing 'Ver más' button.");
                } else {
                    endOfResultsMessage.style.display = 'block'; // Show end of results message
                    console.log("End of results reached.");
                }
            } else if (!append) { // Only show no results if it's the initial display and nothing was found
                noResultsMessage.style.display = 'block';
                console.log("No results found for initial display or filter.");
            }
        }

        function filterAndSortAlojamientos() {
            console.log("filterAndSortAlojamientos called. Applying filters and sorting.");
            const selectedUbicacionRadio = document.querySelector('input[name="ubicacionFilter"]:checked');
            const selectedUbicacion = selectedUbicacionRadio ? selectedUbicacionRadio.value.toLowerCase() : '';

            const selectedCapacidadMaximaInput = capacidadMaximaFilter.value.trim();
            const selectedCapacidadMaxima = selectedCapacidadMaximaInput === '' ? NaN : parseInt(selectedCapacidadMaximaInput);

            const selectedServices = []; // No hay filtro de servicios visible

            const sortOrder = 'rating-desc'; // or 'rating-asc', 'default'

            filteredAlojamientos = allAlojamientos.filter(alojamiento => {
                const matchesUbicacion = selectedUbicacion === '' || (alojamiento.ubicacion && alojamiento.ubicacion.toLowerCase().includes(selectedUbicacion));

                let matchesCapacidad = true;
                if (!isNaN(selectedCapacidadMaxima)) {
                    if (alojamiento.capacidad && alojamiento.capacidad.length === 2) {
                        const minCapacity = alojamiento.capacidad[0];
                        const maxCapacity = alojamiento.capacidad[1];
                        matchesCapacidad = selectedCapacidadMaxima >= minCapacity && selectedCapacidadMaxima <= maxCapacity;
                    } else {
                        matchesCapacidad = false;
                    }
                }

                const matchesServices = true; // No hay filtro de servicios

                return matchesUbicacion && matchesCapacidad && matchesServices;
            });

            if (sortOrder === 'rating-desc') {
                filteredAlojamientos.sort((a, b) => (b.valoracion || 0) - (a.valoracion || 0));
            } else if (sortOrder === 'rating-asc') {
                filteredAlojamientos.sort((a, b) => (a.valoracion || 0) - (b.valoracion || 0));
            }

            // Reset pagination and display the first batch of filtered results
            displayAlojamientos(filteredAlojamientos, false); // Always reset and display first page after filter/sort
            isLoadingMore = false; // Ensure loading flag is reset after a filter/sort operation
            console.log("filterAndSortAlojamientos finished. isLoadingMore set to false.");
        }

        function clearFilters() {
            console.log("clearFilters called.");
            const defaultUbicacionRadio = document.getElementById('ubicacion-todas');
            if (defaultUbicacionRadio) {
                defaultUbicacionRadio.checked = true;
            }

            capacidadMaximaFilter.value = '';

            closeAllDropdowns();
            filterAndSortAlojamientos(); // Re-apply filters which will reset pagination
            console.log("Filters cleared.");
        }

        function loadMoreAlojamientos() {
            console.log("loadMoreAlojamientos called. isLoadingMore:", isLoadingMore);
            if (isLoadingMore) {
                console.log("Already loading more, skipping.");
                return; // Prevent multiple calls
            }
            isLoadingMore = true;
            loadingMessage.style.display = 'block'; // Show loading message for *more* items
            loadMoreButton.style.display = 'none'; // Hide "Ver más" button during load

            currentPage++; // Increment page for the next batch
            console.log("Incrementing currentPage to:", currentPage);


            // Use a timeout to simulate async loading and allow UI to update
            setTimeout(() => {
                console.log("Timeout for loadMoreAlojamientos triggered.");
                displayAlojamientos(filteredAlojamientos, true); // Append more alojamientos
                loadingMessage.style.display = 'none'; // Hide loading message
                isLoadingMore = false; // Allow next scroll to load more
                console.log("loadMoreAlojamientos finished. isLoadingMore set to false.");
            }, 500); // Small delay for visual feedback
        }

        // Event listener for infinite scrolling
        window.addEventListener('scroll', () => {
            // Check if user is near the bottom of the page (e.g., 500px from bottom)
            // Ensure there are more items to potentially load
            const hasMoreItems = (currentPage * itemsPerPage) < filteredAlojamientos.length;
            if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 500) && !isLoadingMore && hasMoreItems) {
                console.log("Reached near bottom, attempting to load more.");
                loadMoreAlojamientos();
            }
        });

        // Event listener for the new "Load More" button
        loadMoreButton.addEventListener('click', loadMoreAlojamientos);

        // Event listeners for filters
        ubicacionFilterRadios.addEventListener('change', filterAndSortAlojamientos);
        applyFiltersButton.addEventListener('click', filterAndSortAlojamientos);
        clearFiltersButton.addEventListener('click', clearFilters);
        capacidadMaximaFilter.addEventListener('input', filterAndSortAlojamientos);

        async function fetchAlojamientos() {
            console.log("fetchAlojamientos called. Showing initial loading message.");
            loadingMessage.style.display = 'block';
            if (errorMessage) errorMessage.style.display = 'none'; // Check if errorMessage element exists

            try {
                const response = await fetch(jsonFile);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allAlojamientos = data.alojamientos || [];
                console.log("JSON data fetched. Total alojamientos:", allAlojamientos.length);
                populateFilters(allAlojamientos);
                filterAndSortAlojamientos(); // Initial display of the first 9 cards
            } catch (error) {
                console.error('Error fetching alojamientos:', error);
                if (errorMessage) { // Ensure errorMessage element exists before trying to access its properties
                    errorMessage.textContent = 'Error al cargar los alojamientos. Por favor, intenta de nuevo más tarde.';
                    errorMessage.style.display = 'block';
                }
                alojamientosContainer.innerHTML = '';
            } finally {
                loadingMessage.style.display = 'none'; // Ensure initial loading message is hidden
                console.log("fetchAlojamientos finished. Hiding initial loading message.");
            }
        }

        fetchAlojamientos();
    </script>
</body>

</html>