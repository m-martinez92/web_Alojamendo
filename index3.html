<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alojamientos en Mendoza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Clase base para todas las tarjetas */
        .card {
            overflow: visible !important; /* Asegura que el contenido pueda salirse de los límites */
            position: relative; /* Permite que z-index funcione en la tarjeta */
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #loadingMessage {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #555;
        }
        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .carousel-images {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .carousel-images img {
            width: 100%;
            flex-shrink: 0;
            height: 224px;
            object-fit: cover;
        }
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 10;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
        }
        .carousel-button:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .carousel-button.prev {
            left: 0.5rem;
        }
        .carousel-button.next {
            right: 0.5rem;
        }

        /* Collapsible content styles */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 1.5rem;
            margin-top: 0.5rem;
        }
        .collapsible-content.expanded {
            max-height: 9999px;
            padding-bottom: 1rem;
        }
        .collapsible-button {
            width: 100%;
            background-color: #f3f4f6;
            color: #4b5563;
            padding: 0.75rem 1.5rem;
            border: none;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border-radius: 0.375rem;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .collapsible-button:hover {
            background-color: #e5e7eb;
        }
        .collapsible-button i {
            margin-left: 0.5rem;
            transition: transform 0.3s ease-in-out;
        }
        .collapsible-button.active i {
            transform: rotate(180deg);
        }

        /* Dropdown styles */
        .dropdown-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000; /* Elevado para asegurar visibilidad */
            border-radius: 0.375rem;
            overflow: hidden;
            width: 100%;
            left: 0;
            top: 100%;
            transform: translateY(0.25rem);
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            transition: background-color 0.2s;
        }
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        .dropdown-container.open .dropdown-content {
            display: block;
        }

        /* Eleva la tarjeta activa */
        .card.active-card {
            z-index: 999; /* Asegura que la tarjeta activa esté por encima de sus vecinas */
        }
        #alojamientosContainer {
            align-items: start;
        }

        /* Specific styles for the filter section */
        #filterSection {
            display: flex;
            flex-direction: column; /* Stacks on small screens */
            gap: 1rem; /* Space between filter groups */
            align-items: flex-end; /* Aligns items to the end of the cross axis */
        }
        @media (min-width: 768px) { /* Medium screens and up */
            #filterSection {
                flex-direction: row; /* Arranges horizontally on medium screens */
                justify-content: flex-start; /* Aligns to start when horizontal */
            }
        }

        .filter-group {
            flex: 1; /* Allows groups to grow and shrink */
            min-width: 150px; /* Minimum width for each filter */
        }

        /* Custom dropdown for services */
        #servicesDropdownContent {
            padding: 0.75rem;
            max-height: 200px; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling for many services */
            /* Removed grid properties */
            display: flex; /* Use flexbox for single column */
            flex-direction: column; /* Stack items vertically */
            gap: 0.5rem; /* Space between checkboxes */
        }
        #servicesDropdownContent .checkbox-item {
            display: flex;
            align-items: center;
            width: 100%; /* Ensure each item takes full width */
            padding: 0.25rem 0; /* Add a little vertical padding */
        }
        #servicesDropdownContent .checkbox-item input[type="checkbox"] {
            /* Ensure uniform checkbox size */
            flex-shrink: 0; /* Prevent checkbox from shrinking */
            width: 1rem; /* Standard width */
            height: 1rem; /* Standard height */
        }
        #servicesDropdownContent .checkbox-item label {
            flex-grow: 1; /* Allow label to take remaining space */
            margin-left: 0.5rem;
            /* Ensure label text doesn't wrap unnecessarily tight, but allows it if needed */
            white-space: normal; /* Allow text to wrap naturally */
        }

    </style>
</head>
<body>
    <header class="bg-gradient-to-r from-black to-gray-700 text-[#c2b64f] shadow-lg">
        <div class="container mx-auto px-6 py-8 text-center">
            <h1 class="text-4xl font-bold">Descubre Alojamientos en Mendoza</h1>
            <p class="mt-2 text-lg">Encuentra el lugar perfecto para tu estadía en la tierra del sol y el buen vino.</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 relative">
            <div id="filterSection" class="flex flex-col md:flex-row md:items-end gap-4 mb-4">
                <div class="filter-group">
                    <label for="ubicacionFilter" class="block text-sm font-medium text-gray-700">Ubicación:</label>
                    <select id="ubicacionFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="">Todas</option>
                        </select>
                </div>

                <div class="filter-group">
                    <label for="capacidadMaximaFilter" class="block text-sm font-medium text-gray-700">Capacidad Máxima:</label>
                    <input type="number" id="capacidadMaximaFilter" min="1" placeholder="Ej: 4" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                </div>

                <div class="filter-group dropdown-container flex-grow">
                    <label for="servicesFilterButton" class="block text-sm font-medium text-gray-700">Servicios:</label>
                    <button id="servicesFilterButton" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-center flex items-center justify-between mt-1">
                        Seleccionar Servicios <i class="fas fa-caret-down ml-2"></i>
                    </button>
                    <div id="servicesDropdownContent" class="dropdown-content">
                        </div>
                </div>

                <div class="flex gap-2">
                    <button id="applyFiltersButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 whitespace-nowrap">Aplicar Filtros</button>
                    <button id="clearFiltersButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors duration-300 whitespace-nowrap">Limpiar</button>
                </div>
            </div>
        </div>

        <div id="alojamientosContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        </div>
        <div id="loadingMessage" style="display: none;">Cargando alojamientos...</div>
        <div id="errorMessage" class="text-red-500 text-center mt-4" style="display: none;"></div>
        <div id="noResultsMessage" class="text-gray-600 text-center mt-4" style="display: none;">No se encontraron alojamientos que coincidan con los filtros aplicados.</div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2025 Alojamientos Mendoza. Todos los derechos reservados.</p>
            <p class="mt-1 text-sm">Diseñado con <span class="text-red-500">&hearts;</span> para tu viaje.</p>
        </div>
    </footer>

    <script>
        const alojamientosContainer = document.getElementById('alojamientosContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const noResultsMessage = document.getElementById('noResultsMessage');

        const ubicacionFilter = document.getElementById('ubicacionFilter');
        const capacidadMaximaFilter = document.getElementById('capacidadMaximaFilter');
        const servicesFilterButton = document.getElementById('servicesFilterButton'); // New: button for services dropdown
        const servicesDropdownContent = document.getElementById('servicesDropdownContent'); // New: services dropdown content

        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const jsonFile = 'alojamientos.json';

        let allAlojamientos = []; // To store all loaded accommodations

        // Function to close all dropdowns (services and social media)
        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-container.open').forEach(openDropdown => {
                openDropdown.classList.remove('open'); // Removes the 'open' class to hide the dropdown
                // Check if this is a social media dropdown and remove active-card class
                const associatedCard = openDropdown.closest('.card'); // Finds the parent card if it's a social media dropdown
                if (associatedCard) {
                    associatedCard.classList.remove('active-card'); // Removes the 'active-card' class
                }
                // Check if this is the services filter dropdown and revert its arrow
                if (openDropdown.contains(servicesFilterButton)) { // Checks if the services filter button is inside this dropdown
                    const icon = servicesFilterButton.querySelector('i'); // Gets the arrow icon
                    if (icon) {
                        icon.classList.remove('fa-caret-up'); // Changes arrow to point down
                        icon.classList.add('fa-caret-down'); // Changes arrow to point down
                    }
                }
            });
        }

        // Global click listener to close dropdowns when clicking outside
        // THIS IS THE CORRECTED PART FROM YOUR SNIPPET
        document.addEventListener('click', (e) => {
            const isClickInsideAnyDropdownContainer = e.target.closest('.dropdown-container'); // Checks if the click was inside any dropdown container
            if (!isClickInsideAnyDropdownContainer) { // If the click was outside all dropdown containers
                closeAllDropdowns(); // Close all open dropdowns
            }
        });

        function crearTarjetaAlojamiento(alojamiento) {
            const tieneWhatsAppValido = alojamiento.whatsapp && alojamiento.whatsapp.trim() !== "" && (alojamiento.activo === undefined || alojamiento.activo === true);

            const card = document.createElement('div');
            card.className = 'card bg-white rounded-lg shadow-md card-hover transition-all duration-300 flex flex-col';

            // Carousel
            const carouselContainer = document.createElement('div');
            carouselContainer.className = 'carousel-container';
            const carouselImages = document.createElement('div');
            carouselImages.className = 'carousel-images';
            let currentImageIndex = 0;
            const imagesToDisplay = alojamiento.imagenes && alojamiento.imagenes.length > 0 ? alojamiento.imagenes : ['https://placehold.co/600x400/CCCCCC/FFFFFF?text=Imagen+No+Disponible'];

            imagesToDisplay.forEach(imgUrl => {
                const img = document.createElement('img');
                img.src = imgUrl;
                img.alt = `Imagen de ${alojamiento.nombre}`;
                img.className = 'w-full h-56 object-cover';
                img.onerror = () => { img.src = 'https://placehold.co/600x400/CCCCCC/FFFFFF?text=Error+Al+Cargar+Imagen'; };
                carouselImages.appendChild(img);
            });
            carouselContainer.appendChild(carouselImages);

            if (imagesToDisplay.length > 1) {
                const prevButton = document.createElement('button');
                prevButton.className = 'carousel-button prev';
                prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevButton.onclick = (e) => {
                    e.stopPropagation();
                    currentImageIndex = (currentImageIndex - 1 + imagesToDisplay.length) % imagesToDisplay.length;
                    carouselImages.style.transform = `translateX(-${currentImageIndex * 100}%)`;
                };
                carouselContainer.appendChild(prevButton);

                const nextButton = document.createElement('button');
                nextButton.className = 'carousel-button next';
                nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextButton.onclick = (e) => {
                    e.stopPropagation();
                    currentImageIndex = (currentImageIndex + 1) % imagesToDisplay.length;
                    carouselImages.style.transform = `translateX(-${currentImageIndex * 100}%)`;
                };
                carouselContainer.appendChild(nextButton);
            }
            card.appendChild(carouselContainer);

            // Content div
            const contentDiv = document.createElement('div');
            contentDiv.className = 'p-6 flex flex-col flex-grow';

            const nombre = document.createElement('h3');
            nombre.className = 'text-2xl font-semibold text-gray-800 mb-2';
            nombre.textContent = alojamiento.nombre;
            contentDiv.appendChild(nombre);

            const descripcion = document.createElement('p');
            descripcion.className = 'text-gray-600 mb-4';
            descripcion.textContent = alojamiento.descripcion;
            contentDiv.appendChild(descripcion);

            // Collapsible details
            if (alojamiento.detallesAdicionales) {
                const collapsibleButton = document.createElement('button');
                collapsibleButton.className = 'collapsible-button';
                collapsibleButton.innerHTML = `Ver más detalles <i class="fas fa-chevron-down"></i>`;
                contentDiv.appendChild(collapsibleButton);

                const collapsibleContent = document.createElement('div');
                collapsibleContent.className = 'collapsible-content';

                if (alojamiento.detallesAdicionales.titulo) {
                    const detallesTitulo = document.createElement('h4');
                    detallesTitulo.className = 'text-lg font-semibold text-gray-700 mb-2 mt-4';
                    detallesTitulo.textContent = alojamiento.detallesAdicionales.titulo;
                    collapsibleContent.appendChild(detallesTitulo);
                }
                if (alojamiento.detallesAdicionales.textoExtenso) {
                    const textoExtenso = document.createElement('p');
                    textoExtenso.className = 'text-gray-600 text-sm mb-2';
                    textoExtenso.textContent = alojamiento.detallesAdicionales.textoExtenso;
                    collapsibleContent.appendChild(textoExtenso);
                }
                if (alojamiento.detallesAdicionales.capacidadMaxima) {
                    const capacidad = document.createElement('p');
                    capacidad.className = 'text-gray-700 text-sm mb-1';
                    capacidad.innerHTML = `<strong>Capacidad:</strong> ${alojamiento.detallesAdicionales.capacidadMaxima}`;
                    collapsibleContent.appendChild(capacidad);
                }
                if (alojamiento.detallesAdicionales.servicios && alojamiento.detallesAdicionales.servicios.length > 0) {
                    const serviciosTitulo = document.createElement('p');
                    serviciosTitulo.className = 'text-gray-700 text-sm font-semibold mt-2 mb-1';
                    serviciosTitulo.textContent = 'Servicios Incluidos:';
                    collapsibleContent.appendChild(serviciosTitulo);
                    const serviciosList = document.createElement('ul');
                    serviciosList.className = 'list-disc list-inside text-gray-600 text-sm mb-2';
                    alojamiento.detallesAdicionales.servicios.forEach(servicio => {
                        const listItem = document.createElement('li');
                        listItem.textContent = servicio;
                        serviciosList.appendChild(listItem);
                    });
                    collapsibleContent.appendChild(serviciosList);
                }
                if (alojamiento.detallesAdicionales.amenities && alojamiento.detallesAdicionales.amenities.length > 0) {
                    const amenitiesTitulo = document.createElement('p');
                    amenitiesTitulo.className = 'text-gray-700 text-sm font-semibold mt-2 mb-1';
                    amenitiesTitulo.textContent = 'Comodidades de la habitación:';
                    collapsibleContent.appendChild(amenitiesTitulo);
                    const amenitiesList = document.createElement('ul');
                    amenitiesList.className = 'list-disc list-inside text-gray-600 text-sm mb-2';
                    alojamiento.detallesAdicionales.amenities.forEach(amenity => {
                        const listItem = document.createElement('li');
                        listItem.textContent = amenity;
                        amenitiesList.appendChild(listItem);
                    });
                    collapsibleContent.appendChild(amenitiesList);
                }

                contentDiv.appendChild(collapsibleContent);

                collapsibleButton.onclick = () => {
                    document.querySelectorAll('.collapsible-content.expanded').forEach(openContent => {
                        if (openContent !== collapsibleContent) {
                            openContent.classList.remove('expanded');
                            const relatedButton = openContent.previousElementSibling;
                            if (relatedButton && relatedButton.classList.contains('collapsible-button')) {
                                relatedButton.classList.remove('active');
                                relatedButton.querySelector('i').classList.remove('fa-chevron-up');
                                relatedButton.querySelector('i').classList.add('fa-chevron-down');
                            }
                        }
                    });

                    collapsibleContent.classList.toggle('expanded');
                    collapsibleButton.classList.toggle('active');
                    const icon = collapsibleButton.querySelector('i');
                    if (collapsibleContent.classList.contains('expanded')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                };
            }

            // Price and location
            const infoDiv = document.createElement('div');
            infoDiv.className = 'flex justify-between items-center mt-auto mb-4';
            const precio = document.createElement('span');
            precio.className = 'text-xl font-bold text-purple-600';
            precio.textContent = alojamiento.precio;
            infoDiv.appendChild(precio);
            const ubicacion = document.createElement('span');
            ubicacion.className = 'text-sm text-gray-500';
            ubicacion.textContent = alojamiento.ubicacion;
            infoDiv.appendChild(ubicacion);
            contentDiv.appendChild(infoDiv);

            // Action buttons (Social media dropdown & WhatsApp)
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'grid grid-cols-1 sm:grid-cols-2 gap-2';

            const dropdownContainer = document.createElement('div');
            dropdownContainer.className = 'dropdown-container';
            const detallesButton = document.createElement('button');
            detallesButton.className = 'w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-center flex items-center justify-center';
            detallesButton.innerHTML = `Redes Sociales <i class="fas fa-caret-down ml-2"></i>`;
            const dropdownContent = document.createElement('div');
            dropdownContent.className = 'dropdown-content';

            let hasSocialMedia = false;
            if (alojamiento.redesSociales) {
                for (const platform in alojamiento.redesSociales) {
                    if (alojamiento.redesSociales.hasOwnProperty(platform) && alojamiento.redesSociales[platform]) {
                        const socialLink = document.createElement('a');
                        socialLink.href = alojamiento.redesSociales[platform];
                        socialLink.target = '_blank';
                        socialLink.rel = 'noopener noreferrer';
                        socialLink.textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
                        dropdownContent.appendChild(socialLink);
                        hasSocialMedia = true;
                    }
                }
            }

            if (hasSocialMedia) {
                dropdownContainer.appendChild(detallesButton);
                dropdownContainer.appendChild(dropdownContent);
                buttonsDiv.appendChild(dropdownContainer);

                detallesButton.onclick = (e) => {
                    e.stopPropagation(); // Prevents the click from propagating to the document
                    // Close all dropdowns, then toggle the current one
                    if (!dropdownContainer.classList.contains('open')) { // Only close others if this one is not already open
                        closeAllDropdowns(); // Closes other open dropdowns
                    }
                    dropdownContainer.classList.toggle('open'); // Toggles the current social media dropdown
                    if (dropdownContainer.classList.contains('open')) {
                        card.classList.add('active-card');
                    } else {
                        card.classList.remove('active-card');
                    }
                };
                dropdownContent.addEventListener('click', (e) => { e.stopPropagation(); });
            } else {
                const noSocialMediaButton = document.createElement('button');
                noSocialMediaButton.className = 'w-full bg-gray-300 text-gray-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed';
                noSocialMediaButton.textContent = 'Redes (No disponibles)';
                noSocialMediaButton.disabled = true;
                buttonsDiv.appendChild(noSocialMediaButton);
            }

            if (tieneWhatsAppValido) {
                const whatsappLink = document.createElement('a');
                whatsappLink.href = `https://wa.me/${alojamiento.whatsapp.replace(/\D/g, '')}`;
                whatsappLink.target = '_blank';
                whatsappLink.rel = 'noopener noreferrer';
                whatsappLink.className = 'w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-center';
                whatsappLink.textContent = 'WhatsApp';
                buttonsDiv.appendChild(whatsappLink);
            } else {
                const noWhatsAppButton = document.createElement('button');
                noWhatsAppButton.className = 'w-full bg-gray-300 text-gray-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed';
                noWhatsAppButton.textContent = 'WhatsApp (No disponible)';
                noWhatsAppButton.disabled = true;
                buttonsDiv.appendChild(noWhatsAppButton);
            }

            contentDiv.appendChild(buttonsDiv);
            card.appendChild(contentDiv);
            return card;
        }

        function populateFilters(alojamientos) {
            // Populate Location Filter
            const ubicaciones = new Set(alojamientos.map(a => a.ubicacion).filter(Boolean));
            ubicacionFilter.innerHTML = '<option value="">Todas</option>'; // Reset
            Array.from(ubicaciones).sort().forEach(ubicacion => {
                const option = document.createElement('option');
                option.value = ubicacion;
                option.textContent = ubicacion;
                ubicacionFilter.appendChild(option);
            });

            // Populate Services Filter (inside the dropdown content)
            const allServices = new Set();
            alojamientos.forEach(alojamiento => {
                if (alojamiento.detallesAdicionales && alojamiento.detallesAdicionales.servicios) {
                    alojamiento.detallesAdicionales.servicios.forEach(servicio => {
                        allServices.add(servicio);
                    });
                }
            });
            servicesDropdownContent.innerHTML = ''; // Reset
            Array.from(allServices).sort().forEach(servicio => {
                const div = document.createElement('div');
                div.className = 'checkbox-item'; // Added a class for consistent styling
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `servicio-${servicio.replace(/\s/g, '-')}`;
                input.value = servicio;
                input.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';
                const label = document.createElement('label');
                label.htmlFor = input.id;
                label.className = 'ml-2 block text-sm text-gray-900'; // Removed whitespace-nowrap
                label.textContent = servicio;
                div.appendChild(input);
                div.appendChild(label);
                servicesDropdownContent.appendChild(div);
            });
        }

        function displayAlojamientos(alojamientosToDisplay) {
            alojamientosContainer.innerHTML = '';
            noResultsMessage.style.display = 'none';

            if (alojamientosToDisplay && alojamientosToDisplay.length > 0) {
                alojamientosToDisplay.forEach(alojamiento => {
                    const debeMostrar = alojamiento.activo === true || alojamiento.mostrarSiInactivo === true;
                    if (debeMostrar) {
                        const tarjeta = crearTarjetaAlojamiento(alojamiento);
                        if (tarjeta) {
                            alojamientosContainer.appendChild(tarjeta);
                        }
                    }
                });
            } else {
                noResultsMessage.style.display = 'block';
            }
        }

        function filterAlojamientos() {
            const selectedUbicacion = ubicacionFilter.value.toLowerCase();
            const selectedCapacidadMaxima = parseInt(capacidadMaximaFilter.value);
            // Get selected services from the dropdown content
            const selectedServices = Array.from(servicesDropdownContent.querySelectorAll('input:checked')).map(cb => cb.value);

            const filtered = allAlojamientos.filter(alojamiento => {
                // Filter by Location
                const matchesUbicacion = selectedUbicacion === '' || (alojamiento.ubicacion && alojamiento.ubicacion.toLowerCase().includes(selectedUbicacion));

                // Filter by Max Capacity
                const matchesCapacidad = isNaN(selectedCapacidadMaxima) || (alojamiento.detallesAdicionales && alojamiento.detallesAdicionales.capacidadMaxima >= selectedCapacidadMaxima);

                // Filter by Services
                const matchesServices = selectedServices.length === 0 ||
                                        (alojamiento.detallesAdicionales && alojamiento.detallesAdicionales.servicios &&
                                         selectedServices.every(service => alojamiento.detallesAdicionales.servicios.includes(service)));

                return matchesUbicacion && matchesCapacidad && matchesServices;
            });

            displayAlojamientos(filtered);
            // Close the services dropdown after applying filters
            // This part is called when filters are applied, ensuring it closes.
            const servicesDropdownContainer = servicesFilterButton.closest('.dropdown-container');
            if (servicesDropdownContainer) {
                servicesDropdownContainer.classList.remove('open');
                servicesFilterButton.querySelector('i').classList.remove('fa-caret-up');
                servicesFilterButton.querySelector('i').classList.add('fa-caret-down');
            }
        }

        async function cargarAlojamientos() {
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            noResultsMessage.style.display = 'none';
            alojamientosContainer.innerHTML = '';

            try {
                const response = await fetch(jsonFile);
                if (!response.ok) {
                    throw new Error(`Error al cargar el archivo JSON: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                if (data && data.alojamientos && data.alojamientos.length > 0) {
                    allAlojamientos = data.alojamientos; // Store all accommodations
                    populateFilters(allAlojamientos); // Populate filters once loaded
                    displayAlojamientos(allAlojamientos); // Display all initially
                } else {
                    errorMessage.textContent = 'No se encontraron alojamientos para mostrar.';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching o procesando alojamientos:', error);
                errorMessage.textContent = `No se pudieron cargar los alojamientos. Por favor, intenta más tarde. (${error.message})`;
                errorMessage.style.display = 'block';
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        // Event Listener for Services Dropdown Button
        servicesFilterButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevents the click from propagating to the document
            const parentDropdown = servicesFilterButton.closest('.dropdown-container');

            // Close all dropdowns first, then toggle the current one
            if (!parentDropdown.classList.contains('open')) { // Only close others if this one is not already open
                closeAllDropdowns(); // Closes other open dropdowns (including social media dropdowns)
            }
            parentDropdown.classList.toggle('open');
            const icon = servicesFilterButton.querySelector('i');
            if (parentDropdown.classList.contains('open')) {
                icon.classList.remove('fa-caret-down');
                icon.classList.add('fa-caret-up');
            } else {
                icon.classList.remove('fa-caret-up');
                icon.classList.add('fa-caret-down');
            }
        });

        // Event Listeners for Filter Buttons
        applyFiltersButton.addEventListener('click', filterAlojamientos);
        clearFiltersButton.addEventListener('click', () => {
            ubicacionFilter.value = '';
            capacidadMaximaFilter.value = '';
            // Uncheck all service checkboxes
            servicesDropdownContent.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            filterAlojamientos(); // Re-apply filters with cleared values
        });

        document.addEventListener('DOMContentLoaded', cargarAlojamientos);
    </script>
</body>
</html>